name: CI

on:
  push:
    branches: ['main', 'develop']
  pull_request:
    branches: ['main', 'develop']

permissions:
  contents: read

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      # Pin actions to full commit hash for security (mitigate supply chain attacks)
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.1.7

      - name: Detect Go version from go.mod
        id: goversion
        run: echo "version=$(grep '^go ' go.mod | awk '{print $2}')" >> $GITHUB_OUTPUT

      - name: Set up Go
        uses: actions/setup-go@0c52d547c9bc32b1aa3301fd7a9cb496313a4491 # v5.0.0
        with:
          go-version: ${{ steps.goversion.outputs.version }}
          check-latest: true
          cache: false

      - name: Test
        run: go test -v ./...

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      # Pin actions to full commit hash for security (mitigate supply chain attacks)
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.1.7

      - name: Detect Go version from go.mod
        id: goversion
        run: echo "version=$(grep '^go ' go.mod | awk '{print $2}')" >> $GITHUB_OUTPUT

      - name: Set up Go
        uses: actions/setup-go@0c52d547c9bc32b1aa3301fd7a9cb496313a4491 # v5.0.0
        with:
          go-version: ${{ steps.goversion.outputs.version }}
          check-latest: true
          cache: false

      - name: Cache golangci-lint
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.2.0
        with:
          path: ~/go/bin/golangci-lint
          key: golangci-lint-${{ runner.os }}-${{ steps.goversion.outputs.version }}

      - name: Install golangci-lint
        run: |
          if ! command -v golangci-lint &> /dev/null; then
            go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
          fi

      - name: Run golangci-lint
        run: golangci-lint run

  notify:
    name: Slack Notification
    runs-on: ubuntu-latest
    needs: [test, lint]
    if: failure()
    steps:
      - name: Notify Slack on Failure
        uses: rtCamp/action-slack-notify@e31e87e03bca4d44e5999eb3ecff9c14c4f42b67 # v2.3.3
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_COLOR: danger
          SLACK_TITLE: '‚ùå CI Failed'
          SLACK_MESSAGE: |
            <@U06Q4AVJUPJ> CI workflow failed.
            *Branch:* `${{ github.ref_name }}`
            *Commit:* `${{ github.sha }}`
            *Actor:* ${{ github.actor }}
            *Details:* ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          SLACK_FOOTER: 'go-armory CI'
